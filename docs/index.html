<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<title>Fund Arena — hedge-labs</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
  :root {
    --bg-primary: #0b0e14;
    --bg-card: #151922;
    --bg-card-alt: #1a1f2b;
    --bg-table-row: #151922;
    --bg-table-alt: #1a1f2b;
    --bg-hover: #222838;
    --text-primary: #e4e4e7;
    --text-secondary: #a1a1aa;
    --text-muted: #71717a;
    --green: #22c55e;
    --red: #ef4444;
    --border: #242a38;
    --fund-a: #3b82f6;
    --fund-b: #a855f7;
    --fund-c: #f97316;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg-primary);
    color: var(--text-primary);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    line-height: 1.5;
    min-height: 100vh;
  }

  .container { max-width: 1280px; margin: 0 auto; padding: 2rem 1.5rem; }

  /* Header */
  .header { margin-bottom: 2.5rem; }
  .header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .header h1 span { opacity: 0.4; font-weight: 400; }
  .header-logo { height: 1.75rem; width: auto; }
  .header-meta {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-top: 0.5rem;
    font-size: 0.8rem;
    color: var(--text-muted);
  }
  .header-meta a { color: var(--text-secondary); text-decoration: none; }
  .header-meta a:hover { color: var(--text-primary); }

  /* Stat row */
  .stat-row {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }
  .stat-pill {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem 1.25rem;
    flex: 1;
    min-width: 160px;
  }
  .stat-pill .label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); margin-bottom: 0.25rem; }
  .stat-pill .value { font-size: 1.35rem; font-weight: 700; font-variant-numeric: tabular-nums; }
  .stat-pill .sub { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.15rem; }

  /* Chart */
  .chart-wrap {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    position: relative;
  }
  .chart-wrap h2 { font-size: 0.95rem; font-weight: 600; margin-bottom: 1rem; }
  #perfChart { width: 100%; height: 380px; }

  /* Table */
  .table-wrap {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    overflow-x: auto;
  }
  .table-wrap h2 { font-size: 0.95rem; font-weight: 600; margin-bottom: 1rem; }

  table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
  thead th {
    text-align: left;
    padding: 0.6rem 0.75rem;
    color: var(--text-muted);
    font-weight: 500;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
  }
  thead th:hover { color: var(--text-secondary); }
  thead th .sort-arrow { margin-left: 0.3rem; opacity: 0.4; }
  thead th.active .sort-arrow { opacity: 1; }
  tbody td {
    padding: 0.55rem 0.75rem;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
    font-variant-numeric: tabular-nums;
  }
  tbody tr:hover { background: var(--bg-hover); }

  .dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 0.4rem;
    vertical-align: middle;
  }
  .pos { color: var(--green); }
  .neg { color: var(--red); }
  .badge {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 500;
  }
  .badge-success { background: rgba(34,197,94,0.12); color: var(--green); }
  .badge-fail { background: rgba(239,68,68,0.12); color: var(--red); }
  .rank-cell { font-weight: 700; }

  /* Fund cards */
  .fund-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
  .fund-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
    position: relative;
    overflow: hidden;
  }
  .fund-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
  }
  .fund-card[data-fund="fund-a"]::before { background: var(--fund-a); }
  .fund-card[data-fund="fund-b"]::before { background: var(--fund-b); }
  .fund-card[data-fund="fund-c"]::before { background: var(--fund-c); }

  .fund-card .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
  .fund-card .card-title { font-weight: 600; font-size: 0.95rem; }
  .fund-card .card-provider { font-size: 0.75rem; color: var(--text-secondary); }
  .fund-card .card-model { font-size: 0.7rem; color: var(--text-muted); font-family: monospace; }
  .fund-card .card-rank {
    font-size: 1.5rem;
    font-weight: 800;
    line-height: 1;
  }
  .fund-card .card-rank-label { font-size: 0.6rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.06em; text-align: right; }
  .fund-card .card-stats {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.75rem;
    font-size: 0.8rem;
  }
  .fund-card .card-stats .stat-label { color: var(--text-muted); font-size: 0.65rem; text-transform: uppercase; }
  .fund-card .card-stats .stat-val { font-weight: 600; font-variant-numeric: tabular-nums; }

  .holdings-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
  .holdings-table th {
    text-align: left;
    padding: 0.35rem 0.5rem;
    color: var(--text-muted);
    font-weight: 500;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    border-bottom: 1px solid var(--border);
  }
  .holdings-table td { padding: 0.3rem 0.5rem; border-bottom: 1px solid var(--border); }
  .holdings-table .ticker { font-weight: 600; cursor: default; }
  .holdings-table .ticker[title] { border-bottom: 1px dotted var(--text-muted); }
  .weight-bar-bg {
    background: rgba(255,255,255,0.06);
    border-radius: 3px;
    height: 6px;
    width: 60px;
    display: inline-block;
    vertical-align: middle;
    overflow: hidden;
  }
  .weight-bar-fill { height: 100%; border-radius: 3px; }

  /* Index cards */
  .index-cards-section { margin-bottom: 2rem; }
  .index-cards-section h2 { font-size: 0.95rem; font-weight: 600; margin-bottom: 0.75rem; }
  .index-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 0.65rem;
  }
  .index-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.85rem 1rem;
    position: relative;
    overflow: hidden;
  }
  .index-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
  }
  .index-card .idx-name {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-bottom: 0.15rem;
    display: flex;
    align-items: center;
    gap: 0.35rem;
  }
  .index-card .idx-ticker {
    font-size: 0.65rem;
    color: var(--text-muted);
    font-family: monospace;
  }
  .index-card .idx-return {
    font-size: 1.1rem;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    margin-top: 0.25rem;
  }

  /* Footer */
  .footer {
    text-align: center;
    padding: 2rem 0;
    font-size: 0.75rem;
    color: var(--text-muted);
    border-top: 1px solid var(--border);
  }
  .footer a { color: var(--text-secondary); text-decoration: none; }
  .footer a:hover { color: var(--text-primary); }

  /* Loading */
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 4rem;
    color: var(--text-muted);
    font-size: 0.9rem;
  }

  @media (max-width: 640px) {
    .container { padding: 1rem; }
    .stat-row { gap: 0.5rem; }
    .stat-pill { min-width: 120px; padding: 0.75rem; }
    .stat-pill .value { font-size: 1.1rem; }
    .fund-cards { grid-template-columns: 1fr; }
    #perfChart { height: 280px; }
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1><img src="hedgelabs-logo.svg" alt="hedge-labs" class="header-logo">Fund Arena <span>/ hedge-labs</span></h1>
    <div class="header-meta">
      <span id="lastUpdated">Loading...</span>
      <a href="https://github.com/zchwyng/hedge-labs" target="_blank">GitHub</a>
    </div>
  </div>

  <div class="fund-cards" id="fundCards"></div>

  <div class="chart-wrap">
    <h2>Cumulative Performance</h2>
    <div id="perfChart"></div>
  </div>

  <div class="stat-row" id="statRow"></div>

  <div class="index-cards-section">
    <h2>Market Indices</h2>
    <div class="index-cards" id="indexCards"></div>
  </div>

  <div class="table-wrap">
    <h2>Daily Runs</h2>
    <table id="runsTable">
      <thead><tr id="tableHead"></tr></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div class="footer">
    Paper only &mdash; not investment advice.<br>
    <a href="https://github.com/zchwyng/hedge-labs" target="_blank">zchwyng/hedge-labs</a>
  </div>
</div>

<script>
const TICKER_NAMES = {
  AAPL:'Apple', ABBV:'AbbVie', ABNB:'Airbnb', ADBE:'Adobe', ADI:'Analog Devices',
  ADP:'ADP', ADSK:'Autodesk', AMAT:'Applied Materials', AMD:'AMD', AMGN:'Amgen',
  AMZN:'Amazon', AVGO:'Broadcom', AXP:'American Express', BA:'Boeing', BAC:'Bank of America',
  BRK:'Berkshire Hathaway', CAT:'Caterpillar', COP:'ConocoPhillips', COST:'Costco',
  CRM:'Salesforce', CRWD:'CrowdStrike', CSCO:'Cisco', CVX:'Chevron', DE:'Deere',
  DIS:'Disney', ENPH:'Enphase Energy', F:'Ford', FTNT:'Fortinet', GE:'GE Aerospace',
  GLD:'SPDR Gold Trust', GOOG:'Alphabet', GOOGL:'Alphabet', GS:'Goldman Sachs',
  HD:'Home Depot', HON:'Honeywell', IBM:'IBM', INTC:'Intel', ISRG:'Intuitive Surgical',
  JNJ:'Johnson & Johnson', JPM:'JPMorgan Chase', KLAC:'KLA Corp', LIN:'Linde',
  LLY:'Eli Lilly', LMT:'Lockheed Martin', LOW:'Lowe\'s', MA:'Mastercard',
  MCD:'McDonald\'s', META:'Meta Platforms', MRK:'Merck', MSFT:'Microsoft',
  MU:'Micron', NEE:'NextEra Energy', NFLX:'Netflix', NOW:'ServiceNow',
  NVDA:'Nvidia', NVO:'Novo Nordisk', PANW:'Palo Alto Networks', PEP:'PepsiCo',
  PG:'Procter & Gamble', PLTR:'Palantir', PYPL:'PayPal', QCOM:'Qualcomm',
  RTX:'RTX Corp', SBUX:'Starbucks', SNOW:'Snowflake', T:'AT&T', TGT:'Target',
  TMO:'Thermo Fisher', TSLA:'Tesla', TSM:'TSMC', TXN:'Texas Instruments',
  UNH:'UnitedHealth', UNP:'Union Pacific', V:'Visa', VZ:'Verizon',
  WMT:'Walmart', XLI:'Industrial Select Sector SPDR', XOM:'ExxonMobil', ZS:'Zscaler',
};
function tickerName(t) { return TICKER_NAMES[t] || t; }

const FUND_LABELS = { 'fund-a': 'Fund A', 'fund-b': 'Fund B', 'fund-c': 'Fund C' };
const PROVIDER_LABELS = { openai: 'OpenAI', anthropic: 'Anthropic', xai: 'xAI' };
const INDEX_STYLE = {
  SPY:       { color: '#8b8fa3', dash: [6, 4],  symbol: 'none',     label: 'S\u0026P 500' },
  QQQ:       { color: '#5eaac7', dash: [4, 4],  symbol: 'diamond',  label: 'Nasdaq 100' },
  ACWI:      { color: '#7c83a6', dash: [8, 3, 2, 3], symbol: 'none', label: 'MSCI ACWI' },
  GLD:       { color: '#e8c846', dash: [6, 3],  symbol: 'triangle', label: 'Gold' },
  'BTC-USD': { color: '#f59e42', dash: [2, 3],  symbol: 'rect',     label: 'Bitcoin' },
};

function fmt(v, decimals = 2) {
  if (v == null) return '\u2014';
  const n = Number(v);
  const s = n >= 0 ? '+' : '';
  return s + n.toFixed(decimals) + '%';
}

function fmtClass(v) {
  if (v == null) return '';
  return Number(v) >= 0 ? 'pos' : 'neg';
}

function providerLabel(p) { return PROVIDER_LABELS[p] || p; }
function fundLabel(id) { return FUND_LABELS[id] || id; }

async function init() {
  const resp = await fetch('data.json');
  const data = await resp.json();

  const d = new Date(data.generated_at);
  document.getElementById('lastUpdated').textContent =
    'Updated ' + d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) +
    ' at ' + d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', timeZoneName: 'short' });

  const fundIds = Object.keys(data.funds).sort();
  const latestDay = data.days[data.days.length - 1];

  buildStatRow(data, fundIds, latestDay);
  buildChart(data, fundIds);
  buildFundCards(data, fundIds, latestDay);
  buildIndexCards(data, latestDay);
  buildTable(data, fundIds);
}

function buildStatRow(data, fundIds, latestDay) {
  const row = document.getElementById('statRow');
  if (!latestDay) return;

  const lanes = latestDay.lanes.filter(l => l.status === 'success').sort((a, b) => a.rank - b.rank);
  if (lanes.length) {
    const leader = lanes[0];
    row.innerHTML += `
      <div class="stat-pill">
        <div class="label">Leader</div>
        <div class="value" style="color:${data.funds[leader.fund_id]?.color || '#fff'}">${fundLabel(leader.fund_id)}</div>
        <div class="sub">${providerLabel(leader.provider)} &middot; ${fmt(leader.excess_return_pct)} excess</div>
      </div>`;
  }

  const bestReturn = lanes.reduce((best, l) => (l.fund_return_pct ?? -Infinity) > (best.fund_return_pct ?? -Infinity) ? l : best, lanes[0]);
  if (bestReturn) {
    row.innerHTML += `
      <div class="stat-pill">
        <div class="label">Best Return</div>
        <div class="value ${fmtClass(bestReturn.fund_return_pct)}">${fmt(bestReturn.fund_return_pct)}</div>
        <div class="sub">${fundLabel(bestReturn.fund_id)} since inception</div>
      </div>`;
  }

  if (latestDay.comparison) {
    row.innerHTML += `
      <div class="stat-pill">
        <div class="label">Portfolio Overlap</div>
        <div class="value">${(latestDay.comparison.portfolio_overlap_pct ?? 0).toFixed(0)}%</div>
        <div class="sub">Between top funds</div>
      </div>`;
    row.innerHTML += `
      <div class="stat-pill">
        <div class="label">Est. Turnover</div>
        <div class="value">${(latestDay.comparison.turnover_estimate_pct ?? 0).toFixed(0)}%</div>
        <div class="sub">Weight divergence</div>
      </div>`;
  }

  row.innerHTML += `
    <div class="stat-pill">
      <div class="label">Arena Days</div>
      <div class="value">${data.days.length}</div>
      <div class="sub">Since ${data.days[0]?.date || '\u2014'}</div>
    </div>`;
}

function buildChart(data, fundIds) {
  // Filter to only include days where equity prices actually changed (trading days).
  // Keep a day if it's the first, or if any fund's asof_price_date differs from the previous day.
  const tradingDays = [];
  let prevPriceDate = null;
  for (const day of data.days) {
    const successLanes = day.lanes.filter(l => l.status === 'success' && l.asof_price_date);
    const maxPriceDate = successLanes.length > 0
      ? successLanes.map(l => l.asof_price_date).sort().pop()
      : null;
    if (prevPriceDate === null || maxPriceDate !== prevPriceDate) {
      tradingDays.push(day);
      if (maxPriceDate) prevPriceDate = maxPriceDate;
    }
  }
  const chartDays = tradingDays;

  const dates = chartDays.map(d => d.date);
  const series = [];

  // Fund lines — thick, solid, with emphasis focus
  for (const fid of fundIds) {
    const fund = data.funds[fid];
    const points = chartDays.map(day => {
      const lane = day.lanes.find(l => l.fund_id === fid);
      if (!lane || lane.status !== 'success' || lane.fund_return_pct == null) return null;
      return lane.fund_return_pct;
    });
    series.push({
      name: fundLabel(fid) + ' (' + providerLabel(fund.provider) + ')',
      type: 'line',
      data: points,
      symbol: 'circle',
      symbolSize: 7,
      lineStyle: { width: 2.5, color: fund.color },
      itemStyle: { color: fund.color },
      emphasis: { focus: 'series', lineStyle: { width: 4 } },
      connectNulls: true,
      z: 10,
    });
  }

  // Collect benchmark tickers used by funds (shown by default)
  const benchmarkTickers = new Set();
  for (const fid of fundIds) {
    const bTicker = data.funds[fid]?.benchmark?.ticker;
    if (bTicker) benchmarkTickers.add(bTicker);
  }

  // Index lines — distinct colors, dash patterns, and symbols
  // Non-benchmark indices are hidden by default (togglable via legend)
  const legendSelected = {};
  if (chartDays.length > 0) {
    const last = chartDays[chartDays.length - 1];
    for (const idx of last.indices.items) {
      const points = chartDays.map(day => {
        const item = day.indices.items.find(i => i.ticker === idx.ticker);
        return item ? item.return_pct : null;
      });
      const style = INDEX_STYLE[idx.ticker] || { color: '#8b8fa3', dash: [6, 4], symbol: 'none', label: idx.name };
      const isBenchmark = benchmarkTickers.has(idx.ticker);
      if (!isBenchmark) legendSelected[style.label] = false;
      series.push({
        name: style.label,
        type: 'line',
        data: points,
        symbol: style.symbol,
        symbolSize: style.symbol !== 'none' ? 5 : 0,
        showSymbol: style.symbol !== 'none',
        lineStyle: { width: 1.8, color: style.color, type: style.dash },
        itemStyle: { color: style.color, borderWidth: 0 },
        emphasis: { focus: 'series', lineStyle: { width: 3.5, type: 'solid' } },
        connectNulls: true,
        z: 5,
      });
    }
  }

  const chartDom = document.getElementById('perfChart');
  const chart = echarts.init(chartDom);

  // Track mouse Y in pixel coords relative to the chart for nearest-series detection
  let mousePixelY = null;
  chartDom.addEventListener('mousemove', e => {
    const rect = chartDom.getBoundingClientRect();
    mousePixelY = e.clientY - rect.top;
  });
  chartDom.addEventListener('mouseleave', () => { mousePixelY = null; });

  chart.setOption({
    backgroundColor: 'transparent',
    grid: { left: 55, right: 20, top: 50, bottom: 35 },
    legend: {
      top: 4,
      textStyle: { color: '#a1a1aa', fontSize: 11 },
      itemWidth: 14,
      itemHeight: 8,
      itemGap: 18,
      selected: legendSelected,
    },
    tooltip: {
      trigger: 'axis',
      backgroundColor: '#1a1f2b',
      borderColor: '#242a38',
      borderWidth: 1,
      textStyle: { color: '#e4e4e7', fontSize: 12 },
      axisPointer: {
        type: 'line',
        lineStyle: { color: '#333a4d', type: 'dashed' },
        label: { backgroundColor: '#242a38', color: '#a1a1aa', fontSize: 10 },
      },
      formatter: function (params) {
        if (!params || !params.length) return '';

        // Find nearest series to mouse cursor by converting values to pixel Y
        let nearestIdx = 0;
        if (mousePixelY != null) {
          let minDist = Infinity;
          for (let i = 0; i < params.length; i++) {
            if (params[i].value == null) continue;
            // Convert data value to pixel Y using chart coord system
            const pixelY = chart.convertToPixel({ yAxisIndex: 0 }, params[i].value);
            const dist = Math.abs(pixelY - mousePixelY);
            if (dist < minDist) { minDist = dist; nearestIdx = i; }
          }
        }
        const nearestName = params[nearestIdx]?.seriesName;

        let html = '<div style="font-weight:600;margin-bottom:6px">' + params[0].axisValue + '</div>';
        // Sort by value descending
        const sorted = [...params].sort((a, b) => {
          const va = a.value ?? -9999, vb = b.value ?? -9999;
          return vb - va;
        });
        for (const p of sorted) {
          if (p.value == null) continue;
          const v = Number(p.value);
          const sign = v >= 0 ? '+' : '';
          const valColor = v >= 0 ? '#22c55e' : '#ef4444';
          const isNearest = p.seriesName === nearestName;
          const opacity = isNearest ? '1' : '0.35';
          const weight = isNearest ? '700' : '400';
          const nameColor = isNearest ? '#f0f0f2' : '#71717a';
          const valWeight = isNearest ? '700' : '400';
          const arrow = isNearest ? '\u25B8 ' : '';
          html += '<div style="display:flex;align-items:center;gap:6px;margin:3px 0;opacity:' + opacity + '">'
            + '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + p.color + '"></span>'
            + '<span style="flex:1;color:' + nameColor + ';font-weight:' + weight + '">' + arrow + p.seriesName + '</span>'
            + '<span style="font-weight:' + valWeight + ';font-variant-numeric:tabular-nums;color:' + valColor + '">' + sign + v.toFixed(2) + '%</span>'
            + '</div>';
        }
        return html;
      },
    },
    xAxis: {
      type: 'category',
      data: dates,
      axisLine: { lineStyle: { color: '#242a38' } },
      axisTick: { show: false },
      axisLabel: { color: '#71717a', fontSize: 10 },
    },
    yAxis: {
      type: 'value',
      axisLine: { show: false },
      axisTick: { show: false },
      splitLine: { lineStyle: { color: '#1e2330' } },
      axisLabel: { color: '#71717a', fontSize: 10, formatter: v => (v >= 0 ? '+' : '') + v.toFixed(1) + '%' },
    },
    series,
  });

  // Dispatch highlight on the nearest series so chart lines dim via emphasis.focus
  let lastHighlighted = null;
  chart.on('showTip', function (params) {
    // When tooltip shows, find nearest series and highlight it
    if (mousePixelY == null || params.dataIndex == null) return;
    const allSeries = chart.getOption().series;
    let minDist = Infinity;
    let nearestName = null;
    for (let i = 0; i < allSeries.length; i++) {
      const val = allSeries[i].data?.[params.dataIndex];
      if (val == null) continue;
      const py = chart.convertToPixel({ yAxisIndex: 0 }, val);
      const dist = Math.abs(py - mousePixelY);
      if (dist < minDist) { minDist = dist; nearestName = allSeries[i].name; }
    }
    if (nearestName && nearestName !== lastHighlighted) {
      if (lastHighlighted) chart.dispatchAction({ type: 'downplay', seriesName: lastHighlighted });
      chart.dispatchAction({ type: 'highlight', seriesName: nearestName });
      lastHighlighted = nearestName;
    }
  });
  chart.on('hideTip', function () {
    if (lastHighlighted) {
      chart.dispatchAction({ type: 'downplay', seriesName: lastHighlighted });
      lastHighlighted = null;
    }
  });

  window.addEventListener('resize', () => chart.resize());
}

function buildFundCards(data, fundIds, latestDay) {
  const container = document.getElementById('fundCards');
  // Sort fund IDs by rank (rank 1 first)
  const sortedFundIds = [...fundIds].sort((a, b) => {
    const laneA = latestDay?.lanes.find(l => l.fund_id === a);
    const laneB = latestDay?.lanes.find(l => l.fund_id === b);
    return (laneA?.rank ?? Infinity) - (laneB?.rank ?? Infinity);
  });
  for (const fid of sortedFundIds) {
    const fund = data.funds[fid];
    const lane = latestDay?.lanes.find(l => l.fund_id === fid);
    const holdings = data.latest_holdings[fid] || [];

    const rankNum = lane?.rank ?? '\u2014';
    const returnPct = lane?.fund_return_pct;
    const excessPct = lane?.excess_return_pct;

    let holdingsRows = '';
    for (const h of holdings) {
      holdingsRows += `<tr>
        <td class="ticker" title="${tickerName(h.ticker)}">${h.ticker}</td>
        <td>
          <div class="weight-bar-bg">
            <div class="weight-bar-fill" style="width:${Math.min(h.weight_pct * 2.5, 100)}%;background:${fund.color}40"></div>
          </div>
          ${h.weight_pct}%
        </td>
        <td>${h.sector}</td>
      </tr>`;
    }

    container.innerHTML += `
      <div class="fund-card" data-fund="${fid}">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="dot" style="background:${fund.color}"></span>${fundLabel(fid)}</div>
            <div class="card-provider">${providerLabel(fund.provider)}</div>
            <div class="card-model">${fund.model}</div>
          </div>
          <div style="text-align:right">
            <div class="card-rank" style="color:${fund.color}">#${rankNum}</div>
            <div class="card-rank-label">Rank</div>
          </div>
        </div>
        <div class="card-stats">
          <div><div class="stat-label">Return</div><div class="stat-val ${fmtClass(returnPct)}">${fmt(returnPct)}</div></div>
          <div><div class="stat-label">Excess</div><div class="stat-val ${fmtClass(excessPct)}">${fmt(excessPct)}</div></div>
          <div><div class="stat-label">Benchmark</div><div class="stat-val">${fund.benchmark?.name || '\u2014'}</div></div>
        </div>
        <table class="holdings-table">
          <thead><tr><th>Ticker</th><th>Weight</th><th>Sector</th></tr></thead>
          <tbody>${holdingsRows}</tbody>
        </table>
      </div>`;
  }
}

function buildIndexCards(data, latestDay) {
  const container = document.getElementById('indexCards');
  if (!latestDay || !latestDay.indices?.items) return;

  const inceptionDate = data.days[0]?.date || '';

  for (const idx of latestDay.indices.items) {
    const style = INDEX_STYLE[idx.ticker] || { color: '#8b8fa3', label: idx.name };
    const v = idx.return_pct;
    container.innerHTML += `
      <div class="index-card">
        <div style="position:absolute;top:0;left:0;right:0;height:2px;background:${style.color}"></div>
        <div class="idx-name">
          <span class="dot" style="background:${style.color}"></span>
          ${style.label}
        </div>
        <div class="idx-ticker">${idx.ticker}</div>
        <div class="idx-return ${fmtClass(v)}">${fmt(v)}</div>
        <div style="font-size:0.6rem;color:var(--text-muted);margin-top:0.2rem">since ${inceptionDate}</div>
      </div>`;
  }
}

// --- Sortable table ---
const TABLE_COLS = [
  { key: 'date',       label: 'Date' },
  { key: 'fund',       label: 'Fund' },
  { key: 'provider',   label: 'Provider' },
  { key: 'status',     label: 'Status' },
  { key: 'action',     label: 'Action' },
  { key: 'fund_return', label: 'Return %' },
  { key: 'bench',      label: 'Benchmark %' },
  { key: 'excess',     label: 'Excess %' },
  { key: 'rank',       label: 'Rank' },
];

let tableRows = [];
let sortCol = 'date';
let sortAsc = false;

function buildTable(data, fundIds) {
  tableRows = [];
  for (const day of data.days) {
    for (const lane of day.lanes) {
      tableRows.push({
        date: day.date,
        fund_id: lane.fund_id,
        fund: fundLabel(lane.fund_id),
        provider: providerLabel(lane.provider),
        providerRaw: lane.provider,
        status: lane.status,
        action: lane.action || '\u2014',
        fund_return: lane.fund_return_pct,
        bench: lane.benchmark_return_pct,
        excess: lane.excess_return_pct,
        rank: lane.rank,
        color: data.funds[lane.fund_id]?.color || '#6b7280',
      });
    }
  }

  const thead = document.getElementById('tableHead');
  thead.innerHTML = '';
  for (const col of TABLE_COLS) {
    const th = document.createElement('th');
    th.innerHTML = col.label + ' <span class="sort-arrow">&#9650;</span>';
    th.dataset.key = col.key;
    th.addEventListener('click', () => {
      if (sortCol === col.key) { sortAsc = !sortAsc; }
      else { sortCol = col.key; sortAsc = true; }
      renderTable();
    });
    thead.appendChild(th);
  }

  renderTable();
}

function renderTable() {
  const sorted = [...tableRows].sort((a, b) => {
    let va = a[sortCol], vb = b[sortCol];
    if (va == null && vb == null) return 0;
    if (va == null) return 1;
    if (vb == null) return -1;
    if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb || '').toLowerCase(); }
    if (va < vb) return sortAsc ? -1 : 1;
    if (va > vb) return sortAsc ? 1 : -1;
    return 0;
  });

  document.querySelectorAll('#tableHead th').forEach(th => {
    const isActive = th.dataset.key === sortCol;
    th.classList.toggle('active', isActive);
    const arrow = th.querySelector('.sort-arrow');
    if (arrow) arrow.innerHTML = isActive ? (sortAsc ? '&#9650;' : '&#9660;') : '&#9650;';
  });

  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';
  for (const r of sorted) {
    const statusBadge = r.status === 'success'
      ? '<span class="badge badge-success">OK</span>'
      : '<span class="badge badge-fail">FAIL</span>';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date}</td>
      <td><span class="dot" style="background:${r.color}"></span>${r.fund}</td>
      <td>${r.provider}</td>
      <td>${statusBadge}</td>
      <td>${r.action}</td>
      <td class="${fmtClass(r.fund_return)}">${fmt(r.fund_return)}</td>
      <td class="${fmtClass(r.bench)}">${fmt(r.bench)}</td>
      <td class="${fmtClass(r.excess)}">${fmt(r.excess)}</td>
      <td class="rank-cell">${r.rank ?? '\u2014'}</td>`;
    tbody.appendChild(tr);
  }
}

init();
</script>
</body>
</html>
