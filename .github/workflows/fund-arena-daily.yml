name: Fund Arena (daily)

on:
  schedule:
    - cron: "17 6 * * *"
  workflow_dispatch:
    inputs:
      run_date:
        description: "Override run date (YYYY-MM-DD). Leave blank for today's UTC date."
        required: false
        default: ""
      publish_outputs:
        description: "Commit/push run outputs to main"
        required: false
        default: "false"
      post_discord:
        description: "Post Discord digest"
        required: false
        default: "false"

permissions:
  contents: write

concurrency:
  group: fund-arena-main
  cancel-in-progress: false

jobs:
  discover_lanes:
    name: Discover lanes
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build lane matrix
        id: matrix
        run: |
          set -euo pipefail

          if ! command -v jq >/dev/null 2>&1; then
            echo "jq is required on runner" >&2
            exit 1
          fi

          lanes="$(
            find funds -mindepth 1 -maxdepth 1 -type d -name 'fund-*' | sort | while read -r fund_dir; do
              config_path="${fund_dir}/fund.config.json"
              [ -f "$config_path" ] || continue
              fund_id="$(basename "$fund_dir")"
              provider="$(jq -r '.provider // empty' "$config_path")"
              if [ -z "$provider" ] || [ "$provider" = "null" ]; then
                continue
              fi
              jq -cn --arg fund_id "$fund_id" --arg provider "$provider" '{fund_id: $fund_id, provider: $provider}'
            done | jq -cs '{include: .}'
          )"

          echo "matrix=$(echo "$lanes" | jq -c .)" >> "$GITHUB_OUTPUT"

  run_lanes:
    name: Run lane - ${{ matrix.fund_id }} / ${{ matrix.provider }}
    runs-on: ubuntu-latest
    needs: discover_lanes
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix: ${{ fromJSON(needs.discover_lanes.outputs.matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute run context
        id: run_context
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.run_date }}" ]; then
            RUN_DATE="${{ github.event.inputs.run_date }}"
          else
            RUN_DATE="$(date -u +%F)"
          fi
          RUN_PATH="funds/${{ matrix.fund_id }}/runs/${RUN_DATE}/${{ matrix.provider }}"
          mkdir -p "$RUN_PATH"

          echo "run_date=$RUN_DATE" >> "$GITHUB_OUTPUT"
          echo "run_path=$RUN_PATH" >> "$GITHUB_OUTPUT"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: |
          if [ -f package.json ]; then
            bun install
          else
            echo "Skipping bun install: package.json not found."
          fi

      - name: Render prompt and run lane
        id: run_lane
        env:
          FINANCIAL_DATASETS_API_KEY: ${{ secrets.FINANCIAL_DATASETS_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DEXTER_MAX_ITERATIONS: "10"
        run: |
          set +e

          RUN_DATE="${{ steps.run_context.outputs.run_date }}"
          RUN_PATH="${{ steps.run_context.outputs.run_path }}"
          PROMPT_PATH="${RUN_PATH}/prompt.txt"

          scripts/render_prompt.sh "${{ matrix.fund_id }}" "$RUN_DATE" "$PROMPT_PATH"
          render_exit=$?

          lane_exit=0
          if [ "$render_exit" -ne 0 ]; then
            lane_exit="$render_exit"
          else
            if [ "${{ matrix.provider }}" = "openai" ]; then
              export ANTHROPIC_API_KEY=""
            fi
            if [ "${{ matrix.provider }}" = "anthropic" ]; then
              export OPENAI_API_KEY=""
            fi

            scripts/run_fund_once.sh "${{ matrix.fund_id }}" "${{ matrix.provider }}" "$RUN_DATE" "$PROMPT_PATH"
            lane_exit=$?
          fi

          echo "$lane_exit" > "${RUN_PATH}/lane_exit_code.txt"
          echo "run_date=$RUN_DATE" >> "$GITHUB_OUTPUT"
          echo "lane_exit=$lane_exit" >> "$GITHUB_OUTPUT"

          exit 0

      - name: Upload lane artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lane-${{ matrix.fund_id }}-${{ matrix.provider }}
          path: ${{ steps.run_context.outputs.run_path }}
          if-no-files-found: warn

      - name: Mark lane failure
        if: steps.run_lane.outputs.lane_exit != '0'
        run: |
          echo "Lane failed with exit code ${{ steps.run_lane.outputs.lane_exit }}"
          exit 1

  finalize_and_publish:
    name: Finalize, Commit, and Publish
    runs-on: ubuntu-latest
    needs: run_lanes
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download lane artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: lane-*
          path: .lane_artifacts
          merge-multiple: false

      - name: Determine run date
        id: run_date
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.run_date }}" ]; then
            echo "run_date=${{ github.event.inputs.run_date }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          RUN_DATE=""
          FIRST_PROMPT="$(find .lane_artifacts -type f -name prompt.txt | head -n 1)"
          if [ -n "$FIRST_PROMPT" ]; then
            RUN_DATE="$(grep -m1 -E 'Run date: [0-9]{4}-[0-9]{2}-[0-9]{2}' "$FIRST_PROMPT" | sed -E 's/.*Run date: ([0-9]{4}-[0-9]{2}-[0-9]{2}).*/\1/')"
          fi

          if ! [[ "$RUN_DATE" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
            RUN_DATE=""
          fi

          if [ -z "$RUN_DATE" ]; then
            RUN_DATE="$(date -u +%F)"
          fi

          echo "run_date=$RUN_DATE" >> "$GITHUB_OUTPUT"

      - name: Hydrate lane artifacts into repo paths
        run: |
          RUN_DATE="${{ steps.run_date.outputs.run_date }}"

          find .lane_artifacts -mindepth 1 -maxdepth 1 -type d | while read -r artifact_dir; do
            artifact_name="$(basename "$artifact_dir")"

            if [[ "$artifact_name" =~ ^lane-(.+)-(.+)$ ]]; then
              fund_id="${BASH_REMATCH[1]}"
              provider="${BASH_REMATCH[2]}"
              dest="funds/${fund_id}/runs/${RUN_DATE}/${provider}"
              rm -rf "$dest"
              mkdir -p "$dest"
              cp -a "${artifact_dir}/." "$dest/"
              echo "Hydrated ${artifact_name} -> ${dest}"
            else
              echo "Skipping unexpected artifact name: ${artifact_name}"
            fi
          done

      - name: Build scoreboard
        run: |
          scripts/build_scoreboard.sh "${{ steps.run_date.outputs.run_date }}"

      - name: Commit and push run outputs
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.publish_outputs }}" != "true" ]; then
            echo "Skipping publish: workflow_dispatch publish_outputs != true"
            exit 0
          fi

          git config user.name "fund-arena-bot"
          git config user.email "fund-arena-bot@users.noreply.github.com"

          git add funds

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "fund-arena: run ${{ steps.run_date.outputs.run_date }}"
          git push origin HEAD:main

      - name: Post Discord digest
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.post_discord }}" != "true" ]; then
            echo "Skipping Discord post: workflow_dispatch post_discord != true"
            exit 0
          fi

          if [ -z "${DISCORD_WEBHOOK_URL}" ]; then
            echo "Missing required secret: DISCORD_WEBHOOK_URL" >&2
            exit 1
          fi

          RUN_DATE="${{ steps.run_date.outputs.run_date }}"
          SCOREBOARD="funds/arena/runs/${RUN_DATE}/scoreboard.json"
          if [ ! -f "$SCOREBOARD" ]; then
            echo "Missing scoreboard: $SCOREBOARD" >&2
            exit 1
          fi

          scripts/build_discord_payload.sh "$RUN_DATE" > discord_payload.json

          jq -c '.[]' discord_payload.json | while IFS= read -r payload; do
            curl -sS -X POST \
              -H "Content-Type: application/json" \
              --data "$payload" \
              "$DISCORD_WEBHOOK_URL"
            sleep 1
          done

      - name: Fail workflow if any lane failed
        if: always()
        run: |
          if [ "${{ needs.run_lanes.result }}" != "success" ]; then
            echo "One or more lanes failed."
            exit 1
          fi
