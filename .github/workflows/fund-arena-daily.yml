name: Fund Arena (daily)

on:
  schedule:
    - cron: "17 6 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: fund-arena-main
  cancel-in-progress: false

jobs:
  run_lanes:
    name: Run lane - ${{ matrix.fund_id }} / ${{ matrix.provider }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - fund_id: fund-a
            provider: openai
          - fund_id: fund-b
            provider: anthropic

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Render prompt and run lane
        id: run_lane
        env:
          FINANCIAL_DATASETS_API_KEY: ${{ secrets.FINANCIAL_DATASETS_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          set +e

          RUN_DATE="$(date -u +%F)"
          RUN_PATH="funds/${{ matrix.fund_id }}/runs/${RUN_DATE}/${{ matrix.provider }}"
          PROMPT_PATH="${RUN_PATH}/prompt.txt"

          mkdir -p "$RUN_PATH"

          scripts/render_prompt.sh "${{ matrix.fund_id }}" "$RUN_DATE" "$PROMPT_PATH"
          render_exit=$?

          lane_exit=0
          if [ "$render_exit" -ne 0 ]; then
            lane_exit="$render_exit"
          else
            if [ "${{ matrix.provider }}" = "openai" ]; then
              export ANTHROPIC_API_KEY=""
            fi
            if [ "${{ matrix.provider }}" = "anthropic" ]; then
              export OPENAI_API_KEY=""
            fi

            scripts/run_fund_once.sh "${{ matrix.fund_id }}" "${{ matrix.provider }}" "$RUN_DATE" "$PROMPT_PATH"
            lane_exit=$?
          fi

          echo "$lane_exit" > "${RUN_PATH}/lane_exit_code.txt"
          echo "run_date=$RUN_DATE" >> "$GITHUB_OUTPUT"
          echo "lane_exit=$lane_exit" >> "$GITHUB_OUTPUT"

          exit 0

      - name: Upload lane artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lane-${{ matrix.fund_id }}-${{ matrix.provider }}
          path: funds/${{ matrix.fund_id }}/runs/${{ steps.run_lane.outputs.run_date }}/${{ matrix.provider }}
          if-no-files-found: warn

      - name: Mark lane failure
        if: steps.run_lane.outputs.lane_exit != '0'
        run: |
          echo "Lane failed with exit code ${{ steps.run_lane.outputs.lane_exit }}"
          exit 1

  finalize_and_publish:
    name: Finalize, Commit, and Publish
    runs-on: ubuntu-latest
    needs: run_lanes
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Download lane artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: lane-*
          path: .
          merge-multiple: true

      - name: Determine run date
        id: run_date
        run: |
          RUN_DATE="$(find funds -type f -name run_meta.json -path '*/runs/*/*/run_meta.json' \
            | sed -E 's#.*\/runs\/([0-9]{4}-[0-9]{2}-[0-9]{2})\/.*#\1#' \
            | sort -u \
            | tail -n 1)"

          if [ -z "$RUN_DATE" ]; then
            RUN_DATE="$(date -u +%F)"
          fi

          echo "run_date=$RUN_DATE" >> "$GITHUB_OUTPUT"

      - name: Build scoreboard
        run: |
          scripts/build_scoreboard.sh "${{ steps.run_date.outputs.run_date }}"

      - name: Commit and push run outputs
        run: |
          git config user.name "fund-arena-bot"
          git config user.email "fund-arena-bot@users.noreply.github.com"

          git add funds

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "fund-arena: run ${{ steps.run_date.outputs.run_date }}"
          git push origin HEAD:main

      - name: Build Discord payload
        id: discord_payload
        run: |
          scripts/build_discord_payload.sh "${{ steps.run_date.outputs.run_date }}" > discord_payload.json
          echo "payload_path=discord_payload.json" >> "$GITHUB_OUTPUT"

      - name: Post Discord summary
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "${DISCORD_WEBHOOK_URL}" ]; then
            echo "Missing required secret: DISCORD_WEBHOOK_URL" >&2
            exit 1
          fi

          curl -sS -X POST \
            -H "Content-Type: application/json" \
            --data @"${{ steps.discord_payload.outputs.payload_path }}" \
            "$DISCORD_WEBHOOK_URL"

      - name: Fail workflow if any lane failed
        if: always()
        run: |
          if [ "${{ needs.run_lanes.result }}" != "success" ]; then
            echo "One or more lanes failed."
            exit 1
          fi
